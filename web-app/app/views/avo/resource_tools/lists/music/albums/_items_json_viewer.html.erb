<% if @resource.record.items_json.present? && @resource.record.items_json["albums"]&.any? %>
  <% albums = @resource.record.items_json["albums"] %>
  <% total_count = albums.length %>
  <% enriched_count = albums.count { |album| album["mb_release_group_id"].present? } %>
  <% missing_count = total_count - enriched_count %>
  <% enrichment_percentage = total_count > 0 ? (enriched_count.to_f / total_count * 100).round : 0 %>

  <%= render Avo::PanelComponent.new(title: "Items JSON Viewer") do |c| %>
    <% c.with_body do %>
    <div class="p-4">
    <div class="stats stats-vertical lg:stats-horizontal shadow mb-6">
      <div class="stat">
        <div class="stat-title">Total Albums</div>
        <div class="stat-value text-primary"><%= total_count %></div>
      </div>

      <div class="stat">
        <div class="stat-title">Enriched with MusicBrainz</div>
        <div class="stat-value text-success"><%= enriched_count %></div>
        <div class="stat-desc"><%= enrichment_percentage %>% complete</div>
      </div>

      <div class="stat">
        <div class="stat-title">Missing MusicBrainz Data</div>
        <div class="stat-value text-error"><%= missing_count %></div>
        <div class="stat-desc"><%= 100 - enrichment_percentage %>% remaining</div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra table-sm border border-gray-300">
        <thead>
          <tr>
            <th class="border border-gray-300">Status</th>
            <th class="border border-gray-300">Rank</th>
            <th class="border border-gray-300">Title</th>
            <th class="border border-gray-300">Artists</th>
            <th class="border border-gray-300">Year</th>
            <th class="border border-gray-300">MusicBrainz Release Group</th>
            <th class="border border-gray-300">MusicBrainz Artists</th>
            <th class="border border-gray-300">Database Album</th>
          </tr>
        </thead>
        <tbody>
          <% albums.sort_by { |a| a["rank"] || 0 }.each do |album| %>
            <% has_mb_data = album["mb_release_group_id"].present? %>
            <tr class="<%= 'bg-gray-100' unless has_mb_data %>">
              <td class="text-center border border-gray-300">
                <% if has_mb_data %>
                  <span class="badge badge-success badge-sm">✓</span>
                <% else %>
                  <span class="badge badge-error badge-sm">✗</span>
                <% end %>
              </td>
              <td class="text-center font-bold border border-gray-300"><%= album["rank"] || '-' %></td>
              <td class="font-semibold border border-gray-300"><%= album["title"] || '-' %></td>
              <td class="border border-gray-300"><%= Array(album["artists"]).join(", ").presence || '-' %></td>
              <td class="text-center border border-gray-300"><%= album["release_year"] || '-' %></td>
              <td class="border border-gray-300">
                <% if album["mb_release_group_id"].present? %>
                  <div class="text-xs font-mono text-gray-600"><%= album["mb_release_group_id"] %></div>
                  <div class="text-sm"><%= album["mb_release_group_name"] %></div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td class="border border-gray-300">
                <% if album["mb_artist_ids"].present? %>
                  <div class="text-xs font-mono text-gray-600"><%= Array(album["mb_artist_ids"]).join(", ") %></div>
                  <div class="text-sm"><%= Array(album["mb_artist_names"]).join(", ") %></div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td class="border border-gray-300">
                <% if album["album_id"].present? %>
                  <div class="text-xs font-mono text-gray-600">ID: <%= album["album_id"] %></div>
                  <div class="text-sm"><%= album["album_name"] %></div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    </div>
    <% end %>
  <% end %>
<% else %>
  <%= render Avo::PanelComponent.new(title: "Items JSON Viewer") do |c| %>
    <% c.with_body do %>
      <div class="alert alert-info m-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>No items_json data available for this list.</span>
      </div>
    <% end %>
  <% end %>
<% end %>
