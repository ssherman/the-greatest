<% if @resource.record.items_json.present? && @resource.record.items_json["songs"]&.any? %>
  <% songs = @resource.record.items_json["songs"] %>
  <% total_count = songs.length %>
  <% enriched_count = songs.count { |song| song["mb_recording_id"].present? } %>
  <% missing_count = total_count - enriched_count %>
  <% enrichment_percentage = total_count > 0 ? (enriched_count.to_f / total_count * 100).round : 0 %>
  <% ai_validated_count = songs.count { |song| song.key?("ai_match_invalid") } %>
  <% ai_invalid_count = songs.count { |song| song["ai_match_invalid"] == true } %>
  <% ai_valid_count = ai_validated_count - ai_invalid_count %>

  <%= render Avo::PanelComponent.new(title: "Items JSON Viewer") do |c| %>
    <% c.with_body do %>
    <div class="p-4">
    <div class="stats stats-vertical lg:stats-horizontal shadow mb-6">
      <div class="stat">
        <div class="stat-title">Total Songs</div>
        <div class="stat-value text-primary"><%= total_count %></div>
      </div>

      <div class="stat">
        <div class="stat-title">Enriched with MusicBrainz</div>
        <div class="stat-value text-success"><%= enriched_count %></div>
        <div class="stat-desc"><%= enrichment_percentage %>% complete</div>
      </div>

      <div class="stat">
        <div class="stat-title">Missing MusicBrainz Data</div>
        <div class="stat-value text-error"><%= missing_count %></div>
        <div class="stat-desc"><%= 100 - enrichment_percentage %>% remaining</div>
      </div>

      <div class="stat">
        <div class="stat-title">AI Validated</div>
        <div class="stat-value text-info"><%= ai_validated_count %></div>
        <div class="stat-desc"><%= ai_invalid_count %> flagged as invalid</div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="table table-zebra table-sm border border-gray-300">
        <thead>
          <tr>
            <th class="border border-gray-300">Status</th>
            <th class="border border-gray-300">Rank</th>
            <th class="border border-gray-300">Title</th>
            <th class="border border-gray-300">Artists</th>
            <th class="border border-gray-300">Year</th>
            <th class="border border-gray-300">MusicBrainz Recording</th>
            <th class="border border-gray-300">MusicBrainz Artists</th>
            <th class="border border-gray-300">Database Song</th>
          </tr>
        </thead>
        <tbody>
          <% songs.sort_by { |s| s["rank"] || 0 }.each do |song| %>
            <% has_mb_data = song["mb_recording_id"].present? %>
            <% ai_flagged_invalid = song["ai_match_invalid"] == true %>
            <tr class="<%= 'bg-gray-100' unless has_mb_data %> <%= 'bg-red-100' if ai_flagged_invalid %>">
              <td class="text-center border border-gray-300">
                <% if ai_flagged_invalid %>
                  <span class="badge badge-error badge-sm">⚠ Invalid</span>
                <% elsif has_mb_data %>
                  <span class="badge badge-success badge-sm">✓</span>
                <% else %>
                  <span class="badge badge-error badge-sm">✗</span>
                <% end %>
              </td>
              <td class="text-center font-bold border border-gray-300"><%= song["rank"] || '-' %></td>
              <td class="font-semibold border border-gray-300"><%= song["title"] || '-' %></td>
              <td class="border border-gray-300"><%= Array(song["artists"]).join(", ").presence || '-' %></td>
              <td class="text-center border border-gray-300"><%= song["release_year"] || '-' %></td>
              <td class="border border-gray-300">
                <% if song["mb_recording_id"].present? %>
                  <div class="text-xs font-mono text-gray-600"><%= song["mb_recording_id"] %></div>
                  <div class="text-sm"><%= song["mb_recording_name"] %></div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td class="border border-gray-300">
                <% if song["mb_artist_ids"].present? %>
                  <div class="text-xs font-mono text-gray-600"><%= Array(song["mb_artist_ids"]).join(", ") %></div>
                  <div class="text-sm"><%= Array(song["mb_artist_names"]).join(", ") %></div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
              <td class="border border-gray-300">
                <% if song["song_id"].present? %>
                  <div class="text-xs font-mono text-gray-600">ID: <%= song["song_id"] %></div>
                  <div class="text-sm"><%= song["song_name"] %></div>
                <% else %>
                  <span class="text-gray-400">-</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    </div>
    <% end %>
  <% end %>
<% else %>
  <%= render Avo::PanelComponent.new(title: "Items JSON Viewer") do |c| %>
    <% c.with_body do %>
      <div class="alert alert-info m-4">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span>No items_json data available for this list.</span>
      </div>
    <% end %>
  <% end %>
<% end %>
