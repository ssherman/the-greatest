<%
  # Compute status
  status = if item.verified?
    "valid"
  elsif item.metadata["ai_match_invalid"]
    "invalid"
  else
    "missing"
  end

  # Status badge class
  status_badge_class = case status
  when "valid"
    "badge badge-success badge-sm"
  when "invalid"
    "badge badge-error badge-sm"
  else
    "badge badge-ghost badge-sm"
  end

  # Status badge icon
  status_badge_icon = case status
  when "valid"
    '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>'.html_safe
  when "invalid"
    '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>'.html_safe
  else
    '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>'.html_safe
  end

  # Row background class
  row_background_class = case status
  when "invalid"
    "bg-error/10"
  when "missing"
    "bg-base-200"
  else
    ""
  end

  # Original data
  original_title = item.metadata["title"].presence || "Unknown Title"
  original_artists = Array(item.metadata["artists"]).join(", ").presence || "Unknown Artist"

  # Matched data - prioritize actual linked song over metadata values
  matched_title = if item.listable.present?
    item.listable.title
  elsif item.metadata["mb_recording_name"].present?
    item.metadata["mb_recording_name"]
  elsif item.metadata["song_name"].present?
    item.metadata["song_name"]
  end

  matched_artists = if item.listable.present? && item.listable.respond_to?(:artists)
    item.listable.artists.map(&:name).join(", ")
  elsif item.metadata["mb_artist_names"].present?
    Array(item.metadata["mb_artist_names"]).join(", ")
  end

  # Source badge
  source_badge = if item.metadata["opensearch_match"]
    score = item.metadata["opensearch_score"]
    score_text = score ? " #{score.round(1)}" : ""
    {text: "OS#{score_text}", badge_class: "badge badge-success badge-sm", title: "OpenSearch Match"}
  elsif item.metadata["musicbrainz_match"]
    {text: "MB", badge_class: "badge badge-info badge-sm", title: "MusicBrainz Match"}
  elsif item.metadata["manual_link"]
    {text: "Manual", badge_class: "badge badge-primary badge-sm", title: "Manual Link"}
  else
    {text: "-", badge_class: "badge badge-ghost badge-sm", title: "No Match"}
  end
%>
<tr
  id="item_row_<%= item.id %>"
  class="<%= row_background_class %>"
  data-status="<%= status %>"
  data-item-id="<%= item.id %>">
  <td>
    <span class="<%= status_badge_class %>" title="<%= status.titleize %>">
      <%= status_badge_icon %>
    </span>
  </td>
  <td><%= item.position %></td>
  <td>
    <div class="font-medium"><%= original_title %></div>
    <div class="text-xs text-base-content/70"><%= original_artists %></div>
  </td>
  <td>
    <% if matched_title %>
      <div class="font-medium"><%= matched_title %></div>
      <% if matched_artists.present? %>
        <div class="text-xs text-base-content/70"><%= matched_artists %></div>
      <% end %>
    <% else %>
      <span class="text-base-content/50">-</span>
    <% end %>
  </td>
  <td>
    <span class="<%= source_badge[:badge_class] %>" title="<%= source_badge[:title] %>">
      <%= source_badge[:text] %>
    </span>
  </td>
  <td>
    <button
      class="btn btn-ghost btn-xs"
      popovertarget="item_menu_<%= item.id %>"
      style="anchor-name: --item-anchor-<%= item.id %>">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z" />
      </svg>
    </button>
    <ul
      class="dropdown menu p-2 shadow bg-base-100 rounded-box w-52"
      popover
      id="item_menu_<%= item.id %>"
      style="position-anchor: --item-anchor-<%= item.id %>">
      <li><%= link_to "Edit Metadata", modal_admin_songs_list_item_path(list_id: item.list_id, id: item.id, modal_type: :edit_metadata), data: { turbo_frame: Admin::Music::Songs::Wizard::SharedModalComponent::FRAME_ID }, onclick: "document.getElementById('item_menu_#{item.id}').hidePopover();" %></li>
      <li><%= link_to "Link Existing Song", modal_admin_songs_list_item_path(list_id: item.list_id, id: item.id, modal_type: :link_song), data: { turbo_frame: Admin::Music::Songs::Wizard::SharedModalComponent::FRAME_ID }, onclick: "document.getElementById('item_menu_#{item.id}').hidePopover();" %></li>
      <li><%= link_to "Search MusicBrainz Recordings", modal_admin_songs_list_item_path(list_id: item.list_id, id: item.id, modal_type: :search_musicbrainz_recordings), data: { turbo_frame: Admin::Music::Songs::Wizard::SharedModalComponent::FRAME_ID }, onclick: "document.getElementById('item_menu_#{item.id}').hidePopover();" %></li>
      <li><%= link_to "Search MusicBrainz Artists", modal_admin_songs_list_item_path(list_id: item.list_id, id: item.id, modal_type: :search_musicbrainz_artists), data: { turbo_frame: Admin::Music::Songs::Wizard::SharedModalComponent::FRAME_ID }, onclick: "document.getElementById('item_menu_#{item.id}').hidePopover();" %></li>
      <li class="border-t border-base-300 mt-1 pt-1">
        <%= button_to "Delete", admin_songs_list_item_path(list_id: item.list_id, id: item.id), method: :delete, class: "text-error", data: { turbo_confirm: "Are you sure you want to delete this item?" }, form: { onclick: "document.getElementById('item_menu_#{item.id}').hidePopover();" } %>
      </li>
    </ul>
  </td>
</tr>
