<%= render(Wizard::StepComponent.new(
  title: "Parse HTML",
  description: "Extract game information from HTML",
  step_number: 1,
  active: true
)) do |step| %>
  <% step.with_step_content do %>
    <% if list.raw_content.blank? %>
      <%# Step 1a: Input HTML %>
      <%= form_with url: helpers.save_html_admin_games_list_wizard_path(list_id: list.id), method: :post, data: { turbo_frame: "wizard_content" } do |f| %>
        <div class="space-y-6">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-bold">Paste HTML Content</span>
            </label>
            <%= f.text_area :raw_content,
                rows: 15,
                placeholder: "Paste the HTML content from your source list here...\n\nFor example:\n1. The Legend of Zelda: Breath of the Wild (2017)\n2. Red Dead Redemption 2 (2018)",
                class: "textarea textarea-bordered w-full font-mono text-sm",
                required: true %>
            <label class="label">
              <span class="label-text-alt">Paste the HTML from a ranked game list. The AI will extract game titles and release years.</span>
            </label>
          </div>

          <div class="flex gap-3">
            <%= f.submit "Save & Continue", class: "btn btn-primary" %>
          </div>
        </div>
      <% end %>
    <% else %>
      <%# Step 1b: Parse existing HTML %>
      <div <% if parse_status == "running" %>
             data-controller="wizard-step"
             data-wizard-step-status-url-value="<%= helpers.step_status_admin_games_list_wizard_path(list_id: list.id, step: 'parse') %>"
             data-wizard-step-step-url-value="<%= helpers.step_admin_games_list_wizard_path(list_id: list.id, step: 'parse') %>"
           <% end %>>

        <div class="card bg-base-200 mb-6">
          <div class="card-body">
            <h3 class="card-title text-sm">HTML Preview</h3>
            <pre class="text-xs overflow-x-auto"><%= raw_content_preview %></pre>
            <% if list.raw_content.length > 500 %>
              <p class="text-xs text-base-content/70">... (truncated)</p>
            <% end %>
          </div>
        </div>

        <% if parse_status == "completed" && parsed_count > 0 %>
          <div class="alert alert-success mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            <div>
              <h3 class="font-bold">Parsing Complete!</h3>
              <div class="text-sm">Successfully parsed <%= parsed_count %> <%= "item".pluralize(parsed_count) %></div>
            </div>
          </div>

          <% all_items = list.list_items.unverified.order(:position) %>
          <% if all_items.any? %>
            <div class="card bg-base-100 border mb-6">
              <div class="card-body">
                <h3 class="card-title text-sm">Parsed Items (<%= parsed_count %>)</h3>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                  <table class="table table-sm table-pin-rows">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Title</th>
                        <th>Year</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% all_items.each do |item| %>
                        <tr>
                          <td><%= item.position %></td>
                          <td><%= item.metadata["title"] %></td>
                          <td><%= item.metadata["release_year"] || "-" %></td>
                        </tr>
                      <% end %>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="mb-6">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm font-medium" data-wizard-step-target="statusText">
                <%= parse_status == "running" ? "Parsing HTML..." : "Ready to parse" %>
              </span>
              <span class="text-sm text-base-content/70">
                <%= parse_progress %>%
              </span>
            </div>
            <progress
              class="progress progress-primary w-full"
              value="<%= parse_progress %>"
              max="100"
              data-wizard-step-target="progressBar">
            </progress>
          </div>

          <% if parse_error.present? %>
            <div class="alert alert-error mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              <span><%= parse_error %></span>
            </div>
          <% end %>
        <% end %>

        <div class="flex gap-3 items-center">
          <% if parse_status == "idle" || parse_status == "failed" %>
            <%= button_to "Start Parsing",
                helpers.advance_step_admin_games_list_wizard_path(list_id: list.id, step: "parse"),
                method: :post,
                class: "btn btn-primary",
                data: {turbo_frame: "wizard_content"} %>
          <% elsif parse_status == "completed" %>
            <%= button_to "Re-parse HTML",
                helpers.reparse_admin_games_list_wizard_path(list_id: list.id),
                method: :post,
                class: "btn btn-outline btn-sm",
                data: {turbo_frame: "wizard_content", confirm: "This will delete existing parsed items and re-parse the HTML. Continue?"} %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
<% end %>
